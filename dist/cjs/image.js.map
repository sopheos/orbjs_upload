{"version":3,"file":"image.js","names":["_file","require","_tsExifParser","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty2","default","getOwnPropertyDescriptors","defineProperties","defineProperty","_callSuper","_getPrototypeOf2","_possibleConstructorReturn2","_isNativeReflectConstruct","Reflect","construct","constructor","Boolean","prototype","valueOf","call","ImageUpload","exports","_FileUpload","options","_this","_classCallCheck2","_options$allowedTypes","allowedTypes","_options$quality","quality","_options$outputType","outputType","_options$orientationA","orientationAllowed","_options$lessCrop","lessCrop","imageOptions","window","_inherits2","_createClass2","key","value","uploadFile","file","data","undefined","reset","isFileTypeValid","resizeAndConvert","uploadBlob","blob","name","File","type","isImageMinSizeValid","width","height","_this2","setError","minWidth","minHeight","isValid","setTimeout","error","next","complete","_this3","some","allowedType","handleOrientationAllowed","maxHeight","maxWidth","_ref","_ref2","_ref3","_ref4","_this4","exif","initialProgress","progress","image","document","createElement","onload","canvas","context","getContext","_this4$imageOptions","_this4$imageOptions$m","_this4$imageOptions$m2","_this4$imageOptions$m3","_this4$imageOptions$m4","maxWRatio","maxHRatio","ratios","ratio","Math","min","_toConsumableArray2","max","newWidth","newHeight","minWRatio","minHRatio","sourceWidth","sourceHeight","x","y","drawImage","metadata","String","lat","lon","blobCallback","nameSplit","split","pop","nameParts","concat","replace","newFile","join","buildFormData","toBlob","reader","FileReader","event","result","target","urlCreator","URL","webkitURL","Data","ExifParserFactory","create","parse","tags","GPSLatitude","GPSLongitude","console","log","src","createObjectURL","readAsArrayBuffer","isWebpSupported","Promise","resolve","img","Image","onerror","isWebpConvertionSupported","toDataURL","match","FileUpload"],"sources":["../../src/image.ts"],"sourcesContent":["import { FileUpload, FileUploadOptions, metadata } from \"./file\";\nimport { ExifParserFactory } from \"ts-exif-parser\";\n\nexport interface Window {\n  URL?: any;\n  webkitURL?: any;\n}\n\n/**\n * ImageUpload options\n * @extends FileUploadOptions\n */\nexport interface ImageUploadOptions extends FileUploadOptions {\n  /** Max width of the image. If to big, image is resized */\n  maxWidth?: number;\n\n  /** Max height of the image. If to big, image is resized */\n  maxHeight?: number;\n\n  /** Min width of the image. If to small, throw an error */\n  minWidth?: number;\n\n  /** Min height of the image. If to small, throw an error */\n  minHeight?: number;\n\n  /**\n   * If true, the max/min Width & Height are interchangeables for validation & resize.\n   * @default true\n   */\n  orientationAllowed?: boolean;\n\n  /**\n   * Image AllowedTypes Format types MIME\n   * @default ['image/jpeg', 'image/png']\n   */\n  allowedTypes?: Array<string>;\n\n  /**\n   * Image AllowedTypes Format types MIME\n   * @default 'image/jpeg' | 'image/webp'\n   */\n  outputType?: \"image/jpeg\" | \"image/webp\";\n\n  /**\n   * Compression quality of the jpeg conversion\n   * @default 0.75\n   */\n  quality?: number;\n\n  /**\n   * Resize strategy when the picture is too big (keep the ratio)\n   * False => Biggest pictures possible, max resolution but can crop a huge part of the picture\n   * True => Keep the most of the picture, min crop but can drop the quality of the picture\n   * @default true\n   */\n  lessCrop?: boolean;\n}\n\n/**\n * Class upload image, to send an image to a server with an axios request\n * @extends FileUpload\n * Documentation : Le live\n */\nexport class ImageUpload extends FileUpload {\n  imageOptions: ImageUploadOptions;\n  window: Window;\n\n  /**\n   * @param {ImageUploadOptions} options\n   */\n  constructor(options: ImageUploadOptions) {\n    const {\n      allowedTypes = [\"image/jpeg\", \"image/png\"],\n      quality = 0.75,\n      outputType = \"image/jpeg\",\n      orientationAllowed = true,\n      lessCrop = false,\n    } = options;\n\n    super(options);\n    this.imageOptions = {\n      allowedTypes,\n      quality,\n      outputType,\n      orientationAllowed,\n      lessCrop,\n      ...this.options,\n      ...options,\n    };\n    this.window = window;\n  }\n\n  /**\n   * Upload image from a file\n   * @param {File} file\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  public uploadFile(\n    file: File,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    this.reset();\n\n    if (!this.isFileTypeValid(file)) {\n      return;\n    }\n\n    this.resizeAndConvert(file, data);\n  }\n\n  /**\n   * Upload image from a blob\n   * @param {Blob} blob\n   * @param {string} name\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  public uploadBlob(\n    blob: Blob,\n    name: string,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    const file = new File([blob], name, { type: blob.type });\n    this.uploadFile(file, data);\n  }\n\n  /**\n   * Determines if webp is supported by the browser\n   * @returns a promise resolving to a boolean to know if webp is supported\n   */\n  public static isWebpSupported(): Promise<Boolean> {\n    return new Promise<Boolean>((resolve) => {\n      const img = new Image();\n      img.onload = () => resolve(img.width === 2 && img.height === 1);\n      img.onerror = () => resolve(false);\n      img.src =\n        \"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==\";\n    });\n  }\n\n  /**\n   * Determines if webp convertion with canvas is supported by the browser\n   * @returns a boolean to know if webp conversion is supported\n   */\n  public static isWebpConvertionSupported(): Boolean {\n    const canvas = document.createElement(\"canvas\");\n    canvas.width = 1;\n    canvas.height = 1;\n    return canvas.toDataURL(\"image/webp\").match(\"image/webp\") !== null;\n  }\n\n  /**\n   * Determines if image min size is valid\n   * Emit error if setError\n   * @param {number} width\n   * @param {number} height\n   * @param {boolean} setError default true\n   * @returns true if image min size valid, false otherwise\n   */\n  protected isImageMinSizeValid(\n    width: number,\n    height: number,\n    setError: boolean = true\n  ): boolean {\n    if (!(this.imageOptions.minWidth && this.imageOptions.minHeight)) {\n      return true;\n    }\n\n    const isValid =\n      width >= this.imageOptions.minWidth &&\n      height >= this.imageOptions.minHeight;\n\n    if (setError && !isValid) {\n      setTimeout(() => this.error.next(\"minsize\"));\n      setTimeout(() => this.complete.next(true));\n    }\n\n    return isValid;\n  }\n\n  /**\n   * Determines if file type is valid\n   * @param {File} file\n   * @returns {boolean} true if file type valid, false otherwise\n   */\n  protected isFileTypeValid(file: File): boolean {\n    if (\n      this.imageOptions.allowedTypes!.length > 0 &&\n      !this.imageOptions.allowedTypes!.some(\n        (allowedType) => allowedType === file.type\n      )\n    ) {\n      setTimeout(() => {\n        const error =\n          file.type === \"image/webp\"\n            ? \"invalid_filetype_webp\"\n            : \"invalid_filetype\";\n        this.error.next(error);\n      });\n      setTimeout(() => this.complete.next(true));\n      this.reset();\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * If orientationAllowed, handle big side/small side instead of width/height\n   *\n   * @param {number} width\n   * @param {number} height\n   */\n  private handleOrientationAllowed(width: number, height: number) {\n    if (!this.imageOptions.orientationAllowed) return;\n\n    // handle max size. If image is wider than higher we make sur that maxWidth is bigger than maxHeight\n    // if not we swap max size\n    if (this.imageOptions.maxHeight && this.imageOptions.maxWidth) {\n      if (width > height) {\n        if (this.imageOptions.maxHeight > this.imageOptions.maxWidth) {\n          [this.imageOptions.maxHeight, this.imageOptions.maxWidth] = [\n            this.imageOptions.maxWidth,\n            this.imageOptions.maxHeight,\n          ];\n        }\n      } else if (this.imageOptions.maxHeight < this.imageOptions.maxWidth) {\n        [this.imageOptions.maxHeight, this.imageOptions.maxWidth] = [\n          this.imageOptions.maxWidth,\n          this.imageOptions.maxHeight,\n        ];\n      }\n    }\n\n    // handle min size. If image is wider than higher we make sur that minWidth is bigger than minHeight\n    // if not we swap min size\n    if (this.imageOptions.minHeight && this.imageOptions.minWidth) {\n      if (width > height) {\n        if (this.imageOptions.minHeight > this.imageOptions.minWidth) {\n          [this.imageOptions.minHeight, this.imageOptions.minWidth] = [\n            this.imageOptions.minWidth,\n            this.imageOptions.minHeight,\n          ];\n        }\n      } else if (this.imageOptions.minHeight < this.imageOptions.minWidth) {\n        [this.imageOptions.minHeight, this.imageOptions.minWidth] = [\n          this.imageOptions.minWidth,\n          this.imageOptions.minHeight,\n        ];\n      }\n    }\n  }\n\n  /**\n   * Build FormData et call sendFiles\n   * Gère les erreurs\n   * @param {File} file\n   * @param {Array<{ name: string, value: string | Blob, fileName?: string }>} data default empty array\n   */\n  private resizeAndConvert(\n    file: File,\n    data: Array<{ name: string; value: string | Blob; fileName?: string }> = []\n  ): void {\n    let exif: any;\n\n    this.initialProgress = 10;\n    setTimeout(() => this.progress.next(this.initialProgress));\n    const image = document.createElement(\"img\");\n    image.onload = () => {\n      const canvas = document.createElement(\"canvas\");\n      const context = canvas.getContext(\"2d\")!;\n      let { width, height } = image;\n\n      this.handleOrientationAllowed(width, height);\n\n      if (!this.isImageMinSizeValid(width, height)) return;\n\n      // if no max/min size, set max/min size to width/height\n      const {\n        maxWidth = width,\n        maxHeight = height,\n        minWidth = width,\n        minHeight = height,\n        lessCrop,\n      } = this.imageOptions;\n\n      // Define ratio to have the biggest image allowed\n      const maxWRatio = maxWidth / width;\n      const maxHRatio = maxHeight / height;\n      const ratios = [maxWRatio, maxHRatio].filter((ratio) => ratio < 1);\n      let ratio = 1;\n      if (ratios.length > 0) {\n        ratio = lessCrop ? Math.min(...ratios) : Math.max(...ratios);\n      }\n      let newWidth = width * ratio;\n      let newHeight = height * ratio;\n\n      // Make sure the ratio respect min size if we need to resize down the image\n      if (newWidth < minWidth || newHeight < minHeight) {\n        const minWRatio = minWidth / width;\n        const minHRatio = minHeight / height;\n        const ratios = [minWRatio, minHRatio].filter((ratio) => ratio < 1);\n        ratio = ratios.length > 0 ? Math.max(...ratios) : 1;\n        newWidth = width * ratio;\n        newHeight = height * ratio;\n      }\n\n      let sourceWidth = newWidth > maxWidth ? maxWidth / ratio : width;\n      let sourceHeight = newHeight > maxHeight ? maxHeight / ratio : height;\n      let x = 0;\n      let y = 0;\n\n      // if needed, offset the exceeding part on the x axis\n      if (newWidth > maxWidth) {\n        x = (width - sourceWidth) / 2;\n        newWidth = maxWidth;\n      }\n\n      // if needed, offset the exceeding part on the y axis\n      if (newHeight > maxHeight) {\n        y = (height - sourceHeight) / 2;\n        newHeight = maxHeight;\n      }\n\n      canvas.width = newWidth;\n      canvas.height = newHeight;\n      context.drawImage(\n        image,\n        x,\n        y,\n        sourceWidth,\n        sourceHeight,\n        0,\n        0,\n        canvas.width,\n        canvas.height\n      );\n\n      const metadata: Array<metadata> = [\n        {\n          name: \"metadata[quality]\",\n          value: String(this.imageOptions.quality),\n        },\n      ];\n\n      if (exif && exif.lat && exif.lon) {\n        metadata.push(\n          {\n            name: \"metadata[lat]\",\n            value: exif.lat,\n          },\n          {\n            name: \"metadata[lon]\",\n            value: exif.lon,\n          }\n        );\n      }\n\n      this.initialProgress = 17;\n      setTimeout(() => this.progress.next(this.initialProgress));\n\n      const blobCallback = (blob: Blob | null): void => {\n        if (!blob) {\n          setTimeout(() => this.error.next(\"default\"));\n          setTimeout(() => this.complete.next(true));\n          this.reset();\n          return;\n        }\n\n        this.initialProgress = 25;\n        setTimeout(() => this.progress.next(this.initialProgress));\n\n        // Rename file with correct extension\n\n        const nameSplit = file.name.split(\".\");\n        nameSplit.pop();\n\n        const nameParts = [...nameSplit, blob.type.replace(\"image/\", \"\")];\n        const newFile = new File([blob], nameParts.join(\".\"), {\n          type: blob.type,\n        });\n\n        this.buildFormData(newFile, [...metadata, ...data]);\n      };\n\n      canvas.toBlob(\n        blobCallback,\n        this.imageOptions.outputType,\n        this.imageOptions.quality\n      );\n    };\n\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const result = event.target!.result;\n\n      const urlCreator = this.window.URL || this.window.webkitURL;\n\n      if (result && typeof result !== \"string\") {\n        try {\n          const Data = ExifParserFactory.create(result).parse();\n          if (Data && Data.tags!.GPSLatitude && Data.tags!.GPSLongitude) {\n            const lat = String(Data.tags!.GPSLatitude);\n            const lon = String(Data.tags!.GPSLongitude);\n            exif = { lat, lon };\n          }\n        } catch (e) {\n          console.log(`can't read exif data`);\n        }\n      }\n      image.src = urlCreator.createObjectURL(file);\n    };\n    reader.readAsArrayBuffer(file);\n  }\n}\n"],"mappings":"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","ignoreList":[]}